<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lembar Ekspedisi Ijazah | F4</title>
    <style>
        /* --- KONTROL PANEL --- */
        body { font-family: Arial, sans-serif; background-color: #525659; margin: 0; padding: 0; text-align: center; }
        .control-panel {
            background: #fff; width: 215mm; margin: 20px auto; padding: 20px;
            border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,.3); text-align: left; box-sizing: border-box;
        }
        .btn-upload { width: 100%; padding: 15px; font-weight: bold; background: #007bff; color: #fff; border: none; cursor: pointer; border-radius: 4px; text-transform: uppercase; margin-top: 10px; }
        
        /* --- SETTING KERTAS F4 (215 x 330 mm) --- */
        @page { 
            size: 215mm 330mm; 
            margin: 1cm; 
        }
        .page-container {
            background: white; width: 215mm; min-height: 330mm; margin: 20px auto; padding: 1cm;
            box-sizing: border-box; box-shadow: 0 0 10px rgba(0,0,0,0.5); text-align: left;
            font-family: "Times New Roman", Times, serif; color: black;
        }

        /* HEADER & KOP (Hanya di halaman pertama) */
        .kop-header { display: flex; align-items: center; border-bottom: 5px double #000; padding-bottom: 10px; margin-bottom: 15px; }
        .logo { width: 75px; height: 75px; margin-right: 20px; }
        .logo img { width: 100%; height: auto; }
        .kop-text { text-align: center; flex: 1; line-height: 1.1; }
        .kop-text h2 { margin: 0; font-size: 18pt; font-weight: bold; color: #006400; }
        .kop-text h3 { margin: 0; font-size: 14pt; font-weight: bold; }
        .kop-text p { margin: 4px 0 0; font-size: 10pt; font-style: italic; }

        .doc-title { text-align: center; margin-bottom: 20px; }
        .doc-title h1 { margin: 0; font-size: 16pt; font-weight: bold; }
        .doc-title span { text-decoration: underline; display: block; margin-top: 5px; font-size: 14pt; }

        /* TABEL STYLE */
        .korcam-section { margin-bottom: 30px; }
        .korcam-label { font-weight: bold; font-size: 13pt; margin: 15px 0 5px 0; border-bottom: 1px solid #000; display: block; }
        
        table { width: 100%; border-collapse: collapse; font-size: 10pt; table-layout: fixed; }
        th, td { border: 1px solid black; padding: 6px 4px; vertical-align: middle; word-wrap: break-word; }
        th { background: #eeeeee !important; text-align: center; font-weight: bold; text-transform: uppercase; font-size: 9pt; }
        
        /* Mengulang Header di Setiap Halaman */
        thead { display: table-header-group; }

        /* Pengaturan Lebar Kolom */
        .col-no { width: 30px; text-align: center; }
        .col-lembaga { width: auto; font-weight: bold; }
        .col-jml { width: 55px; text-align: center; font-weight: bold; }
        .col-waktu { width: 60px; }
        .col-penerima { width: 130px; }
        .col-ttd { width: 120px; font-size: 8pt; vertical-align: top; height: 45px; }
        .col-petugas { width: 70px; }

        @media print {
            body { background: none; }
            .control-panel { display: none !important; }
            .page-container { margin: 0; box-shadow: none; width: 100%; padding: 0; }
            th { -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

<div class="control-panel">
    <h3 style="margin:0 0 10px 0">UPLOAD DATA EKSPEDISI IJAZAH</h3>
    <p style="font-size: 12px; color: #666;">Silakan upload file CSV "Rekap Nilai" untuk membuat Lembar Ekspedisi otomatis.</p>
    <input type="file" id="csvFile" accept=".csv" style="display:none">
    <button class="btn-upload" onclick="document.getElementById('csvFile').click()">PILIH FILE CSV & GENERATE</button>
</div>

<div id="main-output"></div>

<script>
    const LOGO_SRC = "QIRAATI.png";
    const wilayahMap = {
        "01": "Demak",
        "02": "Dewoka",
        "03": "BMW",
        "04": "Karangga",
        "05": "Karbon",
        "06": "Mranggen"
    };

    document.getElementById('csvFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            processData(event.target.result);
        };
        reader.readAsText(file);
    });

    function smartCase(text) {
        if (!text) return "";
        let cleaned = text.trim();
        const whitelist = ["TPQ", "TPA", "SD", "MI", "MTS", "SMP", "MA", "PP.", "SDIT", "TK", "RA", "KH."];
        
        return cleaned.split(' ').map(word => {
            const upperWord = word.toUpperCase().replace(/[.,]/g, '');
            if (whitelist.some(w => w.toUpperCase() === upperWord)) return word.toUpperCase();
            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        }).join(' ');
    }

    function processData(csv) {
        const rows = csv.split('\n');
        // Identifikasi header (pencarian index kolom)
        const headerRow = rows[0].split(';').map(h => h.replace(/"/g, '').trim().toUpperCase());
        
        const idxID = headerRow.indexOf("ID PESERTA");
        const idxLembaga = headerRow.indexOf("ASAL LEMBAGA");
        const idxStatus = headerRow.indexOf("L / TL");

        let dataStore = {}; // { kodeWilayah: { namaLembaga: { l: 0, total: 0, isUpdate: false } } }

        for (let i = 1; i < rows.length; i++) {
            if (!rows[i].trim()) continue;
            const cols = rows[i].split(';').map(v => v.replace(/"/g, '').trim());
            
            const idPeserta = cols[idxID] || "";
            const lembagaRaw = cols[idxLembaga] || "UMUM";
            const status = cols[idxStatus] || "";

            // Ekstrak Kode Wilayah dari ID (EBTAQ25-03.048 -> 03)
            const matchWilayah = idPeserta.match(/-(\d+)\./);
            const kodeWil = matchWilayah ? matchWilayah[1] : "00";

            if (!dataStore[kodeWil]) dataStore[kodeWil] = {};
            
            const namaLembaga = smartCase(lembagaRaw);
            if (!dataStore[kodeWil][namaLembaga]) {
                dataStore[kodeWil][namaLembaga] = { l: 0, total: 0, hasData: false };
            }

            dataStore[kodeWil][namaLembaga].total++;
            if (status === "L") {
                dataStore[kodeWil][namaLembaga].l++;
                dataStore[kodeWil][namaLembaga].hasData = true;
            } else if (status === "TL") {
                dataStore[kodeWil][namaLembaga].hasData = true;
            }
        }

        renderOutput(dataStore);
    }

    function renderOutput(dataStore) {
        const output = document.getElementById('main-output');
        output.innerHTML = '';

        const page = document.createElement('div');
        page.className = 'page-container';
        
        // Header Kop Surat
        page.innerHTML = `
            <div class="kop-header">
                <div class="logo"><img src="${LOGO_SRC}" onerror="this.style.visibility='hidden'"></div>
                <div class="kop-text">
                    <h2>KOORDINATOR PENDIDIKAN AL-QURâ€™AN</h2>
                    <h3>METODE QIROATI CABANG DEMAK</h3>
                    <p>Sekretariat : Jl. Sunan Kalijaga No. 35 Betengan Bintoro Demak Hp. 0896-0898-6635</p>
                </div>
            </div>
            <div class="doc-title">
                <h1>BUKTI PENGAMBILAN IJAZAH</h1>
                <span>Lembar Ekspedisi</span>
            </div>
        `;

        // Urutkan Kode Wilayah
        const sortedWilayah = Object.keys(dataStore).sort();

        sortedWilayah.forEach(kode => {
            const section = document.createElement('div');
            section.className = 'korcam-section';
            
            const namaWil = wilayahMap[kode] || "Lainnya";
            section.innerHTML = `<div class="korcam-label">${kode}. Korcam ${namaWil}</div>`;

            let tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th class="col-no">NO</th>
                            <th class="col-lembaga">NAMA LEMBAGA / TPQ</th>
                            <th class="col-jml">JML (L/Tot)</th>
                            <th class="col-waktu">WAKTU</th>
                            <th class="col-penerima">PENGAMBIL/PENERIMA</th>
                            <th colspan="2" class="col-ttd">TANDA TANGAN</th>
                            <th class="col-petugas">PETUGAS</th>
                        </tr>
                    </thead>
                    <tbody>`;

            // Urutkan Lembaga A-Z dalam wilayah
            const sortedLembaga = Object.keys(dataStore[kode]).sort();
            sortedLembaga.forEach((nama, index) => {
                const d = dataStore[kode][nama];
                const no = index + 1;
                
                // Logika Tampilan Kolom JML
                let displayJml = "";
                if (!d.hasData) {
                    displayJml = ` / ${d.total}`; // Kondisi C: Belum ada riwayat nilai
                } else {
                    displayJml = `${d.l} / ${d.total}`; // Kondisi A & B: Sudah ada L atau 0/Total
                }

                tableHtml += `
                    <tr>
                        <td class="col-no">${no}</td>
                        <td class="col-lembaga">${nama}</td>
                        <td class="col-jml">${displayJml}</td>
                        <td class="col-waktu"></td>
                        <td class="col-penerima"></td>
                        <td class="col-ttd">${no % 2 !== 0 ? no + '.' : ''}</td>
                        <td class="col-ttd">${no % 2 === 0 ? no + '.' : ''}</td>
                        <td class="col-petugas"></td>
                    </tr>
                `;
            });

            tableHtml += `</tbody></table>`;
            section.innerHTML += tableHtml;
            page.appendChild(section);
        });

        output.appendChild(page);
    }
</script>
</body>
</html>
